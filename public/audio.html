<!DOCTYPE html>
<html>
<head>
  <title>Audio Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial; background:#111; color:white; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh;}
    h2 { color:#25d366; margin-bottom:20px;}
    #status { margin-bottom:20px; font-size:18px; }
    button { padding:15px 25px; font-size:18px; border-radius:20px; border:none; margin:10px; cursor:pointer; }
    #startCallBtn { background:#555; color:white; }
    #acceptBtn { display:none; background:#25d366; color:white; }
    audio { display:block; margin:10px auto; width:250px; }
  </style>
</head>
<body>

<h2>Audio Call</h2>
<p id="status">Waiting...</p>
<button id="startCallBtn">Start Call ðŸŽ¤</button>
<button id="acceptBtn">Accept Call ðŸŽ§</button>

<div id="audios"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const audiosContainer = document.getElementById("audios");
const status = document.getElementById("status");
const startCallBtn = document.getElementById("startCallBtn");
const acceptBtn = document.getElementById("acceptBtn");

let localStream;
let pc;
let remoteId;

// 1ï¸âƒ£ Get microphone
navigator.mediaDevices.getUserMedia({ audio: true, video: false })
.then(stream => {
  localStream = stream;
  const audio = document.createElement("audio");
  audio.srcObject = stream;
  audio.autoplay = true;
  audio.muted = true;
  audiosContainer.appendChild(audio);
})
.catch(err => console.error("Microphone access error:", err));

// 2ï¸âƒ£ Start Call
startCallBtn.onclick = () => {
  socket.emit("call-user");
  status.innerText = "Calling...";
};

// 3ï¸âƒ£ Incoming Call
socket.on("incoming-call", ({ callerId }) => {
  status.innerText = "Incoming Call...";
  acceptBtn.style.display = "inline-block";
  remoteId = callerId;

  acceptBtn.onclick = () => {
    acceptBtn.style.display = "none";
    status.innerText = "Call Accepted!";
    startPeer(false);
    socket.emit("accept-call", { callerId: remoteId });
  };
});

// 4ï¸âƒ£ Caller gets accepted
socket.on("call-accepted", ({ accepterId }) => {
  remoteId = accepterId;
  startPeer(true);
});

// 5ï¸âƒ£ Start Peer
function startPeer(isCaller){
  pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });

  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.ontrack = e => {
    const audio = document.createElement("audio");
    audio.srcObject = e.streams[0];
    audio.autoplay = true;
    audiosContainer.appendChild(audio);
  };

  pc.onicecandidate = e => {
    if(e.candidate) socket.emit("ice", { to: remoteId, candidate: e.candidate });
  };

  if(isCaller){
    pc.createOffer().then(offer => {
      pc.setLocalDescription(offer);
      socket.emit("offer", { to: remoteId, offer });
    });
  }
}

// 6ï¸âƒ£ Signaling
socket.on("offer", async ({ from, offer }) => {
  remoteId = from;
  if(!pc) startPeer(false);
  await pc.setRemoteDescription(offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  socket.emit("answer", { to: remoteId, answer });
});

socket.on("answer", async ({ from, answer }) => {
  if(pc) await pc.setRemoteDescription(answer);
});

socket.on("ice", ({ from, candidate }) => {
  if(pc) pc.addIceCandidate(candidate);
});

// 7ï¸âƒ£ Call ended
socket.on("call-ended", () => {
  status.innerText = "Call Ended";
  audiosContainer.innerHTML = "";
  if(pc) pc.close();
  pc = null;
});
</script>

</body>
</html>
